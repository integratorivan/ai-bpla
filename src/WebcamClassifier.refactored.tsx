import { useRef, useEffect } from 'preact/hooks'

// –•—É–∫–∏
import { useModel, useCamera, useStream, usePredictions, useAutoClassification } from './hooks'

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
import { 
  ModelStatus, 
  StreamControls, 
  CameraControls, 
  VideoDisplay, 
  VideoWithOverlay,
  PredictionsDisplay,
  FileUpload,
  ModelSelector,
  DetectionStats
} from './components'

export function WebcamClassifier() {
  // –†–µ—Ñ—ã –¥–ª—è DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  const videoRef = useRef<HTMLVideoElement>(null)
  const canvasRef = useRef<HTMLCanvasElement>(null)
  
  // –•—É–∫–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const model = useModel()
  const camera = useCamera()
  const stream = useStream()
  const predictions = usePredictions()

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
  useEffect(() => {
    model.initialize()
  }, [])

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–æ–¥–µ–ª–∏
  const handleAnalyze = async () => {
    if (model.modelType === 'coco-ssd' && model.tensorflowModel) {
      // –î–µ—Ç–µ–∫—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ —Å COCO-SSD (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
      await predictions.detectObjectsCocoSSD(model.tensorflowModel, videoRef, canvasRef)
    } else if (model.modelType === 'yolo' && model.tensorflowModel) {
      // –î–µ—Ç–µ–∫—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ —Å YOLO (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ)
      await predictions.detectObjects(model.tensorflowModel, videoRef, canvasRef)
    } else if (model.modelType === 'mobilenet' && model.classifier) {
      // –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å MobileNet
      await predictions.classifyFrame(model.classifier, videoRef, canvasRef)
    }
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
  useAutoClassification(
    camera.cameraState.enabled || stream.streamState.isStreamMode || stream.streamState.isFileMode, 
    model.loaded, 
    handleAnalyze, 
    300
  )

  return (
    <div class="webcam-classifier">
      {/* –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –ò–ò */}
      <div class="card">
        <ModelSelector 
          modelState={model}
          onSwitchModel={model.switchModel}
          disabled={predictions.isAnalyzing}
        />
      </div>

      {/* –í—ã–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –≤–∏–¥–µ–æ */}
      <div class="card source-selector">
        <h3>üìπ –ò—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ</h3>
        
        {/* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–æ–π */}
        <CameraControls
          cameraState={camera.cameraState}
          modelLoaded={model.loaded}
          onRequestPermission={camera.requestPermission}
          onEnableCamera={() => camera.enableCamera(videoRef)}
          onDisableCamera={camera.disableCamera}
          onSelectDevice={camera.selectDevice}
          onRefreshDevices={camera.refreshDevices}
        />

        {/* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∏–º–æ–º */}
        <StreamControls
          streamState={stream.streamState}
          modelLoaded={model.loaded}
          onLoadStream={() => stream.loadStream(videoRef)}
          onStopStream={() => stream.stopStream(videoRef)}
          onUrlChange={stream.setUrl}
        />

        {/* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */}
        <FileUpload 
          streamState={stream.streamState}
          modelLoaded={model.loaded}
          onFileLoad={(file) => stream.loadFile(videoRef, file)}
          onStopStream={() => stream.stopStream(videoRef)}
        />
      </div>

      {/* –í–∏–¥–µ–æ –¥–∏—Å–ø–ª–µ–π */}
      <div class="card video-section">
        {/* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º VideoWithOverlay –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–ª–∏—á–∏—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */}
        <VideoWithOverlay 
          videoRef={videoRef}
          canvasRef={canvasRef}
          cameraEnabled={camera.cameraState.enabled || stream.streamState.isStreamMode || stream.streamState.isFileMode}
          onClassifyFrame={handleAnalyze}
          isAnalyzing={predictions.isAnalyzing}
          modelLoaded={model.loaded}
          detections={(model.modelType === 'yolo' || model.modelType === 'coco-ssd') ? predictions.detections : []}
        />
      </div>

      {/* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ */}
      <div class="results-section">
        {/* –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è (MobileNet) */}
        {model.modelType === 'mobilenet' && predictions.predictions.length > 0 && (
          <div class="card">
            <PredictionsDisplay 
              predictions={predictions.predictions}
            />
          </div>
        )}

        {/* –î–µ—Ç–µ–∫—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ (YOLO/COCO-SSD) - —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
        {(model.modelType === 'yolo' || model.modelType === 'coco-ssd') && (
          <div class="card">
            <DetectionStats 
              detections={predictions.detections}
              isAnalyzing={predictions.isAnalyzing}
            />
          </div>
        )}
      </div>

    </div>
  )
} 